<!DOCTYPE html>
<html lang="en">
  <%- include("partials/head") %>
  <body>
    <%- include("partials/errorMsg") %>

    <div class="container py-5">
      <a href="/" class="btn btn-secondary btn-md mb-3 btn-animate-1">
        ‚Üê Back to Menu
      </a>
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card shadow">
            <div class="card-header bg-success text-white">
              <h4 class="mb-0">
                <i class="fa fa-check-circle me-2"></i>Order Confirmation
              </h4>
            </div>

            <div class="card-body">
              <div id="orderSummary"></div>

              <!-- Coupon Section -->
              <div class="border-top pt-3 mt-3">
                <div class="fw-bold">Have a coupon code?</div>
                <div class="input-group mb-3">
                  <input
                    type="text"
                    id="couponCode"
                    class="form-control border-label text-uppercase"
                    placeholder="Enter coupon code"
                    maxlength="20"
                  />
                  <button
                    class="btn btn-outline-success"
                    onclick="applyCoupon()"
                  >
                    Apply
                  </button>
                </div>
                <div id="couponMessage" class="mb-3"></div>
                <div id="discountSummary" class="d-none">
                  <div class="d-flex justify-content-between">
                    <span>Subtotal:</span>
                    <span id="subtotalAmount"></span>
                  </div>
                  <div class="d-flex justify-content-between text-success">
                    <span
                      >Discount (<span id="couponCodeDisplay"></span>):</span
                    >
                    <span id="discountAmount"></span>
                  </div>
                  <hr />
                  <div class="d-flex justify-content-between fw-bold">
                    <span>Total:</span>
                    <span id="finalTotal"></span>
                  </div>
                </div>
              </div>

              <div class="border-top pt-3 mt-3">
                <h5>Choose how to send your order:</h5>

                <div class="d-grid gap-2">
                  <button id="whatsappBtn" class="btn btn-success btn-lg">
                    <i class="fab fa-whatsapp me-2"></i>Send via WhatsApp
                  </button>

                  <button id="copyBtn" class="btn btn-outline-secondary">
                    <i class="fa fa-copy me-2"></i>Copy Order Details
                  </button>

                  <button id="instagramBtn" class="btn btn-outline-dark">
                    <i class="fab fa-instagram me-2"></i>Send via Instagram DM
                  </button>
                </div>

                <div id="copySuccess" class="alert alert-success mt-3 d-none">
                  ‚úÖ Order details copied! You can now paste them anywhere.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/carts.js"></script>
    <script>
      // appliedCoupon is already declared in carts.js
      let originalTotal = 0;

      // Define functions first
      function renderOrderSummary() {
        const cart = getCart();
        const orderSummary = document.getElementById("orderSummary");

        orderSummary.innerHTML = `
          <div class="fw-bold">Order Details:</div>
          ${cart
            .map(
              (item) => `
            <div class="d-flex justify-content-between mb-2">
              <span>${item.name} √ó ${item.quantity}</span>
              <span>‚Ç¶${(item.price * item.quantity).toFixed(2)}</span>
            </div>
          `,
            )
            .join("")}
        `;
      }

      async function applyCoupon() {
        const couponCode = document.getElementById("couponCode").value.trim();
        const messageEl = document.getElementById("couponMessage");

        if (!couponCode) {
          showCouponMessage("Please enter a coupon code", "danger");
          return;
        }

        try {
          const response = await fetch("/api/admin/coupons/validate", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              code: couponCode,
              total: originalTotal,
            }),
          });

          const result = await response.json();

          if (result.valid) {
            appliedCoupon = {
              code: couponCode.toUpperCase(),
              discount: result.discount,
              type: result.coupon.type,
              value: result.coupon.value,
            };

            showCouponMessage(result.message, "success");
            updateTotalDisplay();
          } else {
            appliedCoupon = null;
            showCouponMessage(result.message, "danger");
            updateTotalDisplay();
          }
        } catch (error) {
          console.error("Error validating coupon:", error);
          showCouponMessage(
            "Error validating coupon. Please try again.",
            "danger",
          );
        }
      }

      function showCouponMessage(message, type) {
        const messageEl = document.getElementById("couponMessage");
        messageEl.innerHTML = `<div class="alert alert-${type} alert-sm mb-0">${message}</div>`;
      }

      function updateTotalDisplay() {
        const discountSummary = document.getElementById("discountSummary");

        if (appliedCoupon) {
          const finalTotal = originalTotal - appliedCoupon.discount;

          document.getElementById("subtotalAmount").textContent =
            `‚Ç¶${originalTotal.toFixed(2)}`;
          document.getElementById("couponCodeDisplay").textContent =
            appliedCoupon.code;
          document.getElementById("discountAmount").textContent =
            `-‚Ç¶${appliedCoupon.discount.toFixed(2)}`;
          document.getElementById("finalTotal").textContent =
            `‚Ç¶${finalTotal.toFixed(2)}`;

          discountSummary.classList.remove("d-none");
        } else {
          discountSummary.classList.add("d-none");
        }
      }

      function buildOrderText() {
        const cart = getCart();
        let text = `üõí Order from MorishCart\nüìÖ ${new Date().toLocaleDateString()}\n\n`;
        let total = originalTotal;

        cart.forEach((item, i) => {
          const itemTotal = item.price * item.quantity;
          text += `${i + 1}. ${item.name} √ó ${item.quantity} - ‚Ç¶${itemTotal.toFixed(2)}\n`;
        });

        text += `\nSubtotal: ‚Ç¶${total.toFixed(2)}\n`;

        if (appliedCoupon) {
          text += `Coupon: ${appliedCoupon.code} (-‚Ç¶${appliedCoupon.discount.toFixed(2)})\n`;
          total = total - appliedCoupon.discount;
        }

        text += `üí∞ Total: ‚Ç¶${total.toFixed(2)}\nüìç Delivery needed? Yes/No\nüí≥ Payment: Cash/Transfer\n\nPlease confirm this order üëç`;
        return text;
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Wait for carts.js to load
        setTimeout(() => {
          const cart = getCart();
          const orderSummary = document.getElementById("orderSummary");

          if (cart.length === 0) {
            window.location.href = "/";
            return;
          }

          // Calculate and store original total
          originalTotal = getCartTotal();

          // Render order summary
          renderOrderSummary();
        }, 100);

        // WhatsApp button
        document.getElementById("whatsappBtn").onclick = async () => {
          try {
            const finalTotal = appliedCoupon
              ? originalTotal - appliedCoupon.discount
              : originalTotal;

            const orderPayload = {
              totalAmount: finalTotal,
            };

            // Add coupon data if applied
            if (appliedCoupon) {
              orderPayload.couponCode = appliedCoupon.code;
              orderPayload.discountAmount = appliedCoupon.discount;
            }

            const response = await fetch("/api/checkout/create", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(orderPayload),
            });

            const orderData = await response.json();

            if (!orderData.success) {
              console.error("Server error:", orderData.error);
              alert(`Error creating order: ${orderData.error || 'Please try again.'}`);
              return;
            }

            // Build WhatsApp message
            const cart = getCart();
            const date = new Date().toLocaleDateString();

            let message = `üõí MorishCart Order\n`;
            message += `Order ID: ${orderData.orderId}\n`;
            message += `Date: ${date}\n\n`;
            message += `*ITEMS:*\n`;

            cart.forEach((item, index) => {
              const itemTotal = item.price * item.quantity;
              // Use escapeHtml for safety, but for WhatsApp we need plain text
              const safeName = item.name.replace(/[<>&"']/g, '');
              message += `${index + 1}. ${safeName} √ó ${item.quantity} ‚Äî ‚Ç¶${itemTotal.toFixed(2)}\n`;
            });

            message += `\n----------------------\n`;
            message += `Subtotal: ‚Ç¶${originalTotal.toFixed(2)}\n`;

            message += `Subtotal: ‚Ç¶${originalTotal.toFixed(2)}\n`;

            if (appliedCoupon) {
              message += `Coupon: ${appliedCoupon.code} (-‚Ç¶${appliedCoupon.discount.toFixed(2)})\n`;
              message += `*TOTAL: ‚Ç¶${finalTotal.toFixed(2)}*\n`;
            } else {
              message += `*TOTAL: ‚Ç¶${originalTotal.toFixed(2)}*\n`;
            }

            message += `üìã Ref: ${orderData.verificationCode}\n`;
            message += `----------------------\n\n`;
            message += `Delivery Required: Yes / No\n`;
            message += `Payment Method: Cash / Transfer\n\n`;
            message += `Please confirm availability.`;

            window.open(
              `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`,
              "_blank",
            );
          } catch (error) {
            console.error("Error:", error);
            alert("Error creating order. Please try again.");
          }
        };

        // Copy button
        document.getElementById("copyBtn").onclick = () => {
          const orderText = buildOrderText();
          navigator.clipboard.writeText(orderText).then(() => {
            document.getElementById("copySuccess").classList.remove("d-none");
            setTimeout(() => {
              document.getElementById("copySuccess").classList.add("d-none");
            }, 3000);
          });
        };

        // Instagram button
        document.getElementById("instagramBtn").onclick = () => {
          window.open(`https://instagram.com/${INSTAGRAM_USERNAME}`, "_blank");
        };
      });

      // Auto-uppercase coupon input
      document
        .getElementById("couponCode")
        .addEventListener("input", function () {
          this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, "");
        });
    </script>
  </body>
</html>
